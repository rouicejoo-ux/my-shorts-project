<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Shorts Clone</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <input type="hidden" id="user_id" value="{{ user_id }}">
    <input type="hidden" id="session_id" value="{{ session_id }}">
    <div class="shorts-container">
        <div class="short-start-message"><h2>ìŠ¤í¬ë¡¤í•˜ë©´<br>ìˆí¼ ì‹œì²­ì´ ì‹œì‘ë©ë‹ˆë‹¤</h2></div>
        {% for short in shorts %}
        <div class="short" data-seq="{{ short.seq }}" data-url="{{ short.url }}">
            <div class="player" id="player-{{ short.seq }}" data-video-id="{{ short.video_id }}"></div>
            <div class="progress-bar-container"><div class="progress-bar"></div></div>
            <div class="actions">
                <div class="action-btn like-btn">â¤ï¸<span>0</span></div>
                <div class="action-btn dislike-btn">ğŸ‘<span>0</span></div>
                <div class="action-btn comment-btn">ğŸ’¬<span>{{ short.comment_count }}</span></div>
                <div class="action-btn share-btn state-toggle-btn">ğŸ”—<span>ê³µìœ </span></div>
                <div class="action-btn interested-btn state-toggle-btn">ğŸš«<span>ê´€ì‹¬ì—†ìŒ</span></div>
                <div class="action-btn recommend-btn state-toggle-btn">ğŸ”‡<span>ì±„ë„ì¶”ì²œì•ˆí•¨</span></div>
                <div class="action-btn report-btn state-toggle-btn">ğŸš©<span>ì‹ ê³ </span></div>
            </div>
            <div class="info">
                <div class="channel">
                    <img src="{{ short.channel_profile_url }}" alt="í”„ë¡œí•„">
                    <span>{{ short.channel_name }}</span>
                    <button class="subscribe-btn">êµ¬ë…</button>
                </div>
                <div>{{ short.description }}</div>
            </div>
            <div class="like-anim">â¤ï¸</div>
        </div>
        {% endfor %}
    </div>

    <div class="bottom-nav">
        <div>ğŸ  í™ˆ</div> <div>ğŸ¬ Shorts</div> <div>â•</div> <div>ğŸ“º êµ¬ë…</div> <div>ğŸ‘¤ ë‚´ í˜ì´ì§€</div>
    </div>

    <div class="comments-popup" id="commentsPopup">
        <div class="comments-header"><span id="comment-count">ëŒ“ê¸€</span><button class="close-comment-btn">ë‹«ê¸°</button></div>
        <div class="comments-list" id="commentsList"></div>
        <div class="comment-input"><input type="text" id="commentInput" placeholder="ëŒ“ê¸€ ì¶”ê°€..."><button id="add-comment-btn">ê²Œì‹œ</button></div>
    </div>

    <script>
        const ACTIVITY_MAP = {{ activity_map | tojson }};
        const LAST_WATCHED_URL = "{{ last_watched_url or '' }}";
    </script>
    <script>
        const USER_ID = document.getElementById('user_id').value;
        const SESSION_ID = document.getElementById('session_id').value;
        let currentShortUrl = '';
        let players = {};
        let progressInterval;
        let ignoreNextPauseLog = false;

        // âœ… [ìˆ˜ì •] í˜ì´ì§€ ì´íƒˆ ì‹œì—ë„ ë¡œê·¸ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ keepalive ì˜µì…˜ ì¶”ê°€
        function logEvent(eventType, shortsUrl, useKeepalive = false) {
            const fetchOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    login_id: USER_ID, 
                    shorts_url: shortsUrl, 
                    event_type: eventType, 
                    session_id: SESSION_ID 
                })
            };
            if (useKeepalive) {
                fetchOptions.keepalive = true;
            }
            fetch('/log_event', fetchOptions);
        }
        
        function onYouTubeIframeAPIReady() { const playerDivs = document.querySelectorAll('.player'); playerDivs.forEach(div => { const videoId = div.dataset.videoId; const playerId = div.id; const player = new YT.Player(playerId, { videoId: videoId, playerVars: { 'autoplay': 0, 'controls': 0, 'mute': 0, 'loop': 1, 'playlist': videoId, 'modestbranding': 1, 'showinfo': 0, 'rel': 0 }, events: { 'onStateChange': onPlayerStateChange } }); players[playerId] = player; }); }
        
        function onPlayerStateChange(event) {
            const player = event.target;
            const playerDiv = player.getIframe().parentNode;
            const shortElement = playerDiv.closest('.short');
            if (!shortElement) return;
            const shortsUrl = shortElement.dataset.url;
            const progressBar = shortElement.querySelector('.progress-bar');
            
            if (event.data === YT.PlayerState.PLAYING) {
                logEvent('ì‹œì²­ì‹œì‘', shortsUrl);
                clearInterval(progressInterval);
                progressInterval = setInterval(() => {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    if (duration > 0) { progressBar.style.width = (currentTime / duration) * 100 + '%'; }
                }, 100);
            } else if (event.data === YT.PlayerState.PAUSED) {
                if (ignoreNextPauseLog) {
                    ignoreNextPauseLog = false; 
                } else {
                    logEvent('ì‹œì²­ì¤‘ì§€_ì¢…ë£Œ', shortsUrl);
                }
                clearInterval(progressInterval);
            } else {
                 clearInterval(progressInterval);
                 if (event.data === YT.PlayerState.ENDED) { progressBar.style.width = '0%'; }
            }
        }
        
        const shorts = document.querySelectorAll('.short');
        const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { const playerDiv = entry.target.querySelector('.player'); if (!playerDiv) return; const playerId = playerDiv.id; const player = players[playerId]; if (player && typeof player.playVideo === 'function') { if (entry.isIntersecting) { currentShortUrl = entry.target.dataset.url; player.playVideo(); } else { player.pauseVideo(); } } }); }, { threshold: 0.6 });
        
        function startShortsFeed() {
            shorts.forEach(short => observer.observe(short));
            if (LAST_WATCHED_URL) {
                const lastWatchedElement = document.querySelector(`.short[data-url="${LAST_WATCHED_URL}"]`);
                if (lastWatchedElement) { lastWatchedElement.scrollIntoView({ behavior: 'smooth' }); }
            }
        }

        // --- (ì´í•˜ ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼) ---
        shorts.forEach(short => { short.addEventListener('click', (e) => { const playerDiv = short.querySelector('.player'); if (!playerDiv) return; const playerId = playerDiv.id; const player = players[playerId]; if (player && typeof player.getPlayerState === 'function') { const playerState = player.getPlayerState(); if (playerState === YT.PlayerState.PLAYING) { player.pauseVideo(); } else { player.playVideo(); } } }); });
        function restoreActivityStates() { shorts.forEach(short => { const shortsUrl = short.dataset.url; const state = ACTIVITY_MAP[shortsUrl]; if (!state) return; if (state['ì¢‹ì•„ìš”'] === 1) { const btn = short.querySelector('.like-btn'); btn.querySelector('span').textContent = '1'; btn.classList.add('active'); } if (state['ì‹«ì–´ìš”'] === 1) { const btn = short.querySelector('.dislike-btn'); btn.querySelector('span').textContent = '1'; btn.classList.add('active'); } if (state['ê³µìœ '] === 1) { short.querySelector('.share-btn').classList.add('active'); } if (state['ê´€ì‹¬ì—†ìŒ'] === 1) { short.querySelector('.interested-btn').classList.add('active'); } if (state['ì±„ë„ì¶”ì²œì•ˆí•¨'] === 1) { short.querySelector('.recommend-btn').classList.add('active'); } if (state['ì‹ ê³ '] === 1) { short.querySelector('.report-btn').classList.add('active'); } if (state['êµ¬ë…'] === 1) { const btn = short.querySelector('.subscribe-btn'); btn.textContent = 'êµ¬ë…ì¤‘'; btn.classList.add('active'); } }); }
        window.addEventListener('load', () => {
             restoreActivityStates();
             // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ í”¼ë“œ ì‹œì‘
             startShortsFeed();
        });
        document.querySelectorAll('.short').forEach(short => { const likeBtn = short.querySelector('.like-btn'); const dislikeBtn = short.querySelector('.dislike-btn'); const likeSpan = likeBtn.querySelector('span'); const dislikeSpan = dislikeBtn.querySelector('span'); const shortsUrl = short.dataset.url; likeBtn.addEventListener('click', (e) => { e.stopPropagation(); if (likeSpan.textContent === '0') { likeSpan.textContent = '1'; likeBtn.classList.add('active'); logEvent('ì¢‹ì•„ìš”', shortsUrl); if (dislikeSpan.textContent === '1') { dislikeSpan.textContent = '0'; dislikeBtn.classList.remove('active'); logEvent('ì‹«ì–´ìš”ì·¨ì†Œ', shortsUrl); } } else { likeSpan.textContent = '0'; likeBtn.classList.remove('active'); logEvent('ì¢‹ì•„ìš”ì·¨ì†Œ', shortsUrl); } }); dislikeBtn.addEventListener('click', (e) => { e.stopPropagation(); if (dislikeSpan.textContent === '0') { dislikeSpan.textContent = '1'; dislikeBtn.classList.add('active'); logEvent('ì‹«ì–´ìš”', shortsUrl); if (likeSpan.textContent === '1') { likeSpan.textContent = '0'; likeBtn.classList.remove('active'); logEvent('ì¢‹ì•„ìš”ì·¨ì†Œ', shortsUrl); } } else { dislikeSpan.textContent = '0'; dislikeBtn.classList.remove('active'); logEvent('ì‹«ì–´ìš”ì·¨ì†Œ', shortsUrl); } }); });
        document.querySelectorAll('.state-toggle-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const shortsUrl = e.currentTarget.closest('.short').dataset.url; const isActive = e.currentTarget.classList.toggle('active'); let eventType = ''; if (btn.classList.contains('share-btn')) eventType = 'ê³µìœ '; else if (btn.classList.contains('interested-btn')) eventType = 'ê´€ì‹¬ì—†ìŒ'; else if (btn.classList.contains('recommend-btn')) eventType = 'ì±„ë„ì¶”ì²œì•ˆí•¨'; else if (btn.classList.contains('report-btn')) eventType = 'ì‹ ê³ '; logEvent(isActive ? eventType : eventType + 'ì·¨ì†Œ', shortsUrl); }); });
        document.querySelectorAll('.subscribe-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const shortsUrl = e.currentTarget.closest('.short').dataset.url; if (e.currentTarget.textContent === 'êµ¬ë…') { e.currentTarget.textContent = 'êµ¬ë…ì¤‘'; e.currentTarget.classList.add('active'); logEvent('êµ¬ë…', shortsUrl); } else { e.currentTarget.textContent = 'êµ¬ë…'; e.currentTarget.classList.remove('active'); logEvent('êµ¬ë…ì·¨ì†Œ', shortsUrl); } }); });
        const commentsPopup = document.getElementById('commentsPopup');
        const commentsList = document.getElementById('commentsList');
        const commentCountSpan = document.getElementById('comment-count');
        const commentInput = document.getElementById('commentInput');
        const addCommentBtn = document.getElementById('add-comment-btn');
        function createCommentHTML(comment) { let repliesHTML = ''; if (comment.replies && comment.replies.length > 0) { repliesHTML += '<div class="replies-container">'; comment.replies.forEach(reply => { repliesHTML += createCommentHTML(reply); }); repliesHTML += '</div>'; } return ` <div class="comment" id="comment-${comment.comment_id}"> <img src="${comment.author_profile_image_url || 'https://via.placeholder.com/32'}" alt="í”„ë¡œí•„"> <div class="comment-body"> <div class="comment-meta"><strong>${comment.author_name}</strong> Â· <span class="date">${formatTimeAgo(comment.published_at)}</span></div> <div class="comment-text">${comment.comment_text}</div> <div class="comment-actions"> <span>â¤ï¸ ${comment.like_count}</span> <span onclick="showReplyForm('${comment.comment_id}')">ë‹µê¸€</span> </div> ${repliesHTML} </div> </div>`; }
        function showReplyForm(parentId) { const existingForm = document.getElementById('reply-form'); if(existingForm) existingForm.remove(); const parentComment = document.getElementById(`comment-${parentId}`).querySelector('.comment-body'); const replyFormHTML = ` <div id="reply-form" class="reply-form"> <input type="text" id="reply-input" placeholder="ë‹µê¸€ ì¶”ê°€..."> <button onclick="postComment('${parentId}')">ê²Œì‹œ</button> <button onclick="document.getElementById('reply-form').remove()">ì·¨ì†Œ</button> </div>`; parentComment.insertAdjacentHTML('beforeend', replyFormHTML); document.getElementById('reply-input').focus(); }
        async function postComment(parentId = null) { const inputElem = parentId ? document.getElementById('reply-input') : commentInput; const commentText = inputElem.value.trim(); if (!commentText) return; const response = await fetch('/add_comment', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ shorts_url: currentShortUrl, comment_text: commentText, parent_id: parentId }) }); const newComment = await response.json(); if (newComment.error) { alert('ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: ' + newComment.error); } else { const newCommentHTML = createCommentHTML({ ...newComment, replies: [] }); if (parentId) { const parentContainer = document.getElementById(`comment-${parentId}`).querySelector('.replies-container') || document.getElementById(`comment-${parentId}`).querySelector('.comment-body'); if (!parentContainer.querySelector('.replies-container')) { parentContainer.insertAdjacentHTML('beforeend', '<div class="replies-container"></div>'); } parentContainer.querySelector('.replies-container').insertAdjacentHTML('beforeend', newCommentHTML); document.getElementById('reply-form').remove(); } else { if (commentsList.innerHTML.includes('ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.')) commentsList.innerHTML = ''; commentsList.insertAdjacentHTML('beforeend', newCommentHTML); inputElem.value = ''; commentsList.scrollTop = commentsList.scrollHeight; } } }
        addCommentBtn.addEventListener('click', () => postComment(null));
        commentInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') postComment(null); });
        function toggleComments(shortsUrl) { const popup = document.getElementById('commentsPopup'); const isOpen = popup.style.bottom === "0px"; if (isOpen) { popup.style.bottom = "-100%"; } else { fetchAndRenderComments(shortsUrl); popup.style.bottom = "0px"; } }
        document.querySelectorAll('.comment-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const shortElement = e.currentTarget.closest('.short'); const shortsUrl = shortElement.dataset.url; const playerDiv = shortElement.querySelector('.player'); const playerId = playerDiv.id; const player = players[playerId]; if (player && typeof player.pauseVideo === 'function') { player.pauseVideo(); } logEvent('ëŒ“ê¸€í´ë¦­', shortsUrl); toggleComments(shortsUrl); }); });
        document.querySelector('.close-comment-btn').addEventListener('click', (e) => { logEvent('ëŒ“ê¸€ë‹«ê¸°í´ë¦­', currentShortUrl); toggleComments(currentShortUrl); const currentShortElement = Array.from(shorts).find(short => short.dataset.url === currentShortUrl); if (currentShortElement) { const playerDiv = currentShortElement.querySelector('.player'); const playerId = playerDiv.id; const player = players[playerId]; if (player && typeof player.playVideo === 'function') { ignoreNextPauseLog = true; player.playVideo(); } } });
        function formatTimeAgo(dateString) { const date = new Date(dateString); const now = new Date(); const seconds = Math.floor((now - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "ë…„ ì „"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + "ê°œì›” ì „"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "ì¼ ì „"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "ë¶„ ì „"; return "ë°©ê¸ˆ ì „"; }
        async function fetchAndRenderComments(shortsUrl) { commentsList.innerHTML = 'ë¡œë”© ì¤‘...'; const response = await fetch(`/get_comments?url=${encodeURIComponent(shortsUrl)}`); const comments = await response.json(); commentsList.innerHTML = ''; let totalComments = 0; if (comments.error) { commentsList.innerHTML = 'ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'; } else { comments.forEach(comment => { commentsList.innerHTML += createCommentHTML(comment); totalComments += 1 + (comment.replies ? comment.replies.length : 0); }); if (comments.length === 0) { commentsList.innerHTML = 'ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.'; } } commentCountSpan.textContent = `ëŒ“ê¸€ ${totalComments}ê°œ`; }

// ... (ì´ì „ async function fetchAndRenderComments(shortsUrl) { ... } í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤) ...

        // âœ… [ì¶”ê°€] ìŠ¤í¬ë¡¤ ì œì–´ ë° ì£¼ì†Œì°½ ìˆ¨ê¹€ ë¡œì§
        const shortsContainer = document.querySelector('.shorts-container');
        let canScroll = true;
        let scrollTimeout;

        // ìŠ¤í¬ë¡¤/ìŠ¤ì™€ì´í”„ í›„ ì¼ì • ì‹œê°„ ë™ì•ˆ ì¶”ê°€ ì…ë ¥ì„ ë¬´ì‹œí•˜ëŠ” í•¨ìˆ˜
        function preventScrollAbuse() {
            canScroll = false;
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                canScroll = true;
            }, 800); // 0.7ì´ˆì˜ ë”œë ˆì´ë¥¼ ì¤ë‹ˆë‹¤. ì´ ì‹œê°„ ë™ì•ˆ ì¶”ê°€ ìŠ¤í¬ë¡¤/ìŠ¤ì™€ì´í”„ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤.
        }

        // ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸ ì œì–´
        shortsContainer.addEventListener('wheel', (e) => {
            if (!canScroll) {
                e.preventDefault();
                return;
            }
            preventScrollAbuse();
        }, { passive: false });

        // í„°ì¹˜ ìŠ¤ì™€ì´í”„ ì´ë²¤íŠ¸ ì œì–´ (ëª¨ë°”ì¼ìš©)
        let touchstartY = 0;
        shortsContainer.addEventListener('touchstart', (e) => {
            touchstartY = e.changedTouches[0].screenY;
        }, { passive: true });

        shortsContainer.addEventListener('touchmove', (e) => {
            if (!canScroll) {
                e.preventDefault();
                return;
            }
            const touchendY = e.changedTouches[0].screenY;
            // ì¼ì • ê±°ë¦¬(10px) ì´ìƒ ìŠ¤ì™€ì´í”„í–ˆì„ ë•Œë§Œ ë”œë ˆì´ ì ìš©
            if (Math.abs(touchstartY - touchendY) > 30) { 
                preventScrollAbuse();
            }
        }, { passive: false });
        
        // âœ… [ìˆ˜ì •] í˜ì´ì§€ ë¡œë“œ ì‹œ ì£¼ì†Œì°½ ìˆ¨ê¹€ ë° í”¼ë“œ ì‹œì‘
        window.addEventListener('load', () => {
             restoreActivityStates();
             startShortsFeed();
             // ëª¨ë°”ì¼ì—ì„œ ì£¼ì†Œì°½ì„ ìˆ¨ê¸°ê¸° ìœ„í•´ ì•½ê°„ ìŠ¤í¬ë¡¤
             setTimeout(() => window.scrollTo(0, 1), 100);
        });

        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ì‹œì²­ì¤‘ì§€ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ì „ê³¼ ë™ì¼)
        window.addEventListener('pagehide', () => {
            if (currentShortUrl) {
                // keepalive ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ í˜ì´ì§€ê°€ ë‹«íˆëŠ” ì¤‘ì—ë„ ìš”ì²­ì´ ì·¨ì†Œë˜ì§€ ì•Šë„ë¡ í•¨
                logEvent('ì‹œì²­ì¤‘ì§€_ì¢…ë£Œ', currentShortUrl, true);
            }
        });
    </script>
</body>
</html>