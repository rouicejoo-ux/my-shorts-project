<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Shorts Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <style>
        html, body { position: relative; height: 100%; margin: 0; padding: 0; background-color: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .swiper { width: 100%; height: 100%; }
        .swiper-slide { text-align: center; font-size: 18px; background: #000; display: flex; justify-content: center; align-items: center; }
        .video-container { width: 100%; height: 100%; position: relative; }
        .video-player { width: 100%; height: 100%; object-fit: contain; }
        .ui-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; color: white; text-shadow: 1px 1px 2px black; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); display: flex; justify-content: space-between; align-items: flex-end; }
        .video-info { text-align: left; }
        .channel-info { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .channel-profile { width: 40px; height: 40px; border-radius: 50%; }
        .description { font-size: 14px; }
        .sidebar { display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .sidebar-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .sidebar-icon img { width: 35px; height: 35px; filter: invert(1); }
        .sidebar-icon span { font-size: 12px; margin-top: 5px; }
        .sidebar-icon.active img { filter: invert(48%) sepia(89%) saturate(2221%) hue-rotate(335deg) brightness(101%) contrast(93%); }
        .comments-panel { position: fixed; bottom: -100%; left: 0; width: 100%; height: 60%; background-color: #212121; border-top-left-radius: 20px; border-top-right-radius: 20px; transition: bottom 0.3s ease-in-out; z-index: 1000; display: flex; flex-direction: column; }
        .comments-panel.active { bottom: 0; }
        .comments-header { padding: 15px; text-align: center; color: white; font-weight: bold; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
        .comments-header .close-btn { cursor: pointer; font-size: 24px; line-height: 1; }
        .comments-body { flex-grow: 1; overflow-y: auto; padding: 15px; color: white; }
        .comment-item { display: flex; gap: 10px; margin-bottom: 15px; }
        .comment-author-profile { width: 32px; height: 32px; border-radius: 50%; }
        .comment-content { text-align: left; flex-grow: 1; }
        .comment-author-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .comment-text { font-size: 14px; white-space: pre-wrap; }
        .comment-replies { margin-left: 42px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="swiper">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <div style="color: white; text-align: center;">
                    <h2>감응아비투스_웹사이트</h2>
                    <p>스크롤하면<br>숏폼 시청이 시작됩니다</p>
                </div>
            </div>

            {% for s in shorts %}
            <div class="swiper-slide" data-url="{{ s.url }}" data-seq="{{ s.seq }}" data-video-id="{{ s.video_id }}">
                <div class="video-container">
                    <div id="player-{{ s.seq }}" class="video-player"></div>
                    <div class="ui-overlay">
                        <div class="video-info">
                            <div class="channel-info">
                                <img src="{{ s.channel_profile_url }}" class="channel-profile">
                                <span>{{ s.channel_name }}</span>
                            </div>
                            <p class="description">{{ s.description }}</p>
                        </div>
                        <div class="sidebar">
                            <div class="sidebar-icon like-btn" onclick="handleActivity(this, '좋아요')">
                                <img src="https://static.thenounproject.com/png/5253303-200.png">
                                <span>좋아요</span>
                            </div>
                            <div class="sidebar-icon dislike-btn" onclick="handleActivity(this, '싫어요')">
                                <img src="https://static.thenounproject.com/png/5253301-200.png">
                                <span>싫어요</span>
                            </div>
                             <div class="sidebar-icon comments-btn" onclick="openComments('{{ s.url }}')">
                                <img src="https://static.thenounproject.com/png/5253267-200.png">
                                <span>{{ s.comment_count }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="swiper-pagination"></div>
    </div>

    <div id="comments-panel" class="comments-panel">
        <div class="comments-header">
            <span>댓글</span>
            <span class="close-btn" onclick="closeComments()">&times;</span>
        </div>
        <div id="comments-body" class="comments-body">
            </div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        const USER_ID = '{{ user_id }}';
        const SESSION_ID = '{{ session_id }}';
        let players = {};
        let activePlayer = null;
        let swiper;
        
        function onYouTubeIframeAPIReady() {
            swiper = new Swiper('.swiper', {
                direction: 'vertical',
                pagination: { el: '.swiper-pagination', clickable: true },
                on: {
                    init: function () {
                        // 첫 슬라이드는 안내 문구이므로, 비디오 로드를 하지 않습니다.
                        if (this.activeIndex > 0) {
                           loadAndPlayVideo(this.slides[this.activeIndex]);
                        }
                    },
                    slideChange: function () {
                        stopAllVideos();
                        // 0번 인덱스는 안내 슬라이드이므로 비디오 관련 동작을 하지 않습니다.
                        if (this.activeIndex > 0) {
                            loadAndPlayVideo(this.slides[this.activeIndex]);
                        }
                    }
                }
            });
        }

        function loadAndPlayVideo(slide) {
            if (!slide || !slide.dataset.seq) return; // 안내 슬라이드 예외 처리
            const seq = slide.dataset.seq;
            if (players[seq]) {
                playVideo(seq);
            } else {
                createPlayer(slide);
            }
        }

        function createPlayer(slide) {
            const seq = slide.dataset.seq;
            const videoId = slide.dataset.videoId;
            players[seq] = new YT.Player(`player-${seq}`, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 1, 'playlist': videoId, 'mute': 1 },
                events: { 'onReady': (event) => onPlayerReady(event, seq) }
            });
        }

        function onPlayerReady(event, seq) {
            playVideo(seq);
        }

        function playVideo(seq) {
            if (players[seq] && typeof players[seq].playVideo === 'function') {
                players[seq].playVideo();
                players[seq].unMute();
                activePlayer = players[seq];
                logEvent('시청시작');
            }
        }

        function stopAllVideos() {
            if (activePlayer) {
                logEvent('시청중지_종료');
            }
            for (let seq in players) {
                if (players[seq] && typeof players[seq].stopVideo === 'function') {
                    players[seq].stopVideo();
                }
            }
            activePlayer = null;
        }

        function logEvent(eventType) {
            if (!activePlayer || !activePlayer.getVideoUrl) return;
            const videoData = activePlayer.getVideoData();
            if (!videoData.video_id) return; // 비디오 ID가 없는 경우 (오류 방지)
            const videoUrl = `https://youtube.com/shorts/${videoData.video_id}`;
            fetch('/log_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    login_id: USER_ID,
                    session_id: SESSION_ID,
                    shorts_url: videoUrl,
                    event_type: eventType
                })
            });
        }

        // --- 댓글 페이징 관련 변수 ---
        let currentPage = 1;
        let isLoading = false;
        let hasMoreComments = true;
        let currentShortsUrl = '';
        const commentsPanel = document.getElementById('comments-panel');
        const commentsContainer = document.getElementById('comments-body');

        // --- openComments 함수 ---
        function openComments(shortsUrl) {
            logEvent('댓글클릭');
            currentPage = 1;
            hasMoreComments = true;
            isLoading = false;
            commentsContainer.innerHTML = '';
            currentShortsUrl = shortsUrl;
            
            fetchAndDisplayComments();
            commentsPanel.classList.add('active');
            if (activePlayer) activePlayer.pauseVideo();
        }

        function closeComments() {
            logEvent('댓글닫기클릭');
            commentsPanel.classList.remove('active');
            if (activePlayer) activePlayer.playVideo();
        }

        // --- 댓글을 가져와서 표시하는 함수 ---
        function fetchAndDisplayComments() {
            if (isLoading || !hasMoreComments) return;
            isLoading = true;

            fetch(`/get_comments?url=${encodeURIComponent(currentShortsUrl)}&page=${currentPage}`)
                .then(response => response.json())
                .then(data => {
                    data.comments.forEach(comment => {
                        commentsContainer.innerHTML += renderComment(comment);
                    });
                    hasMoreComments = data.has_next_page;
                    isLoading = false;
                    currentPage++;
                })
                .catch(error => {
                    console.error('Error fetching comments:', error);
                    isLoading = false;
                });
        }

        function renderComment(comment) {
            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                repliesHtml = '<div class="comment-replies">';
                comment.replies.forEach(reply => {
                    repliesHtml += renderSingleComment(reply);
                });
                repliesHtml += '</div>';
            }
            return renderSingleComment(comment) + repliesHtml;
        }

        function renderSingleComment(c) {
            return `
                <div class="comment-item">
                    <img src="${c.author_profile_image_url}" class="comment-author-profile">
                    <div class="comment-content">
                        <div class="comment-author-name">${c.author_name}</div>
                        <div class="comment-text">${c.comment_text}</div>
                    </div>
                </div>
            `;
        }

        // --- 댓글 컨테이너에 스크롤 이벤트 리스너 추가 ---
        commentsContainer.addEventListener('scroll', () => {
            if (commentsContainer.scrollTop + commentsContainer.clientHeight >= commentsContainer.scrollHeight - 10 && !isLoading && hasMoreComments) {
                fetchAndDisplayComments();
            }
        });
        
        // --- (handleActivity 함수는 이전과 동일) ---
        function handleActivity(element, eventType) {
            // ...
        }

    </script>
</body>
</html>